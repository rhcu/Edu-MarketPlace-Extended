{% load static %}
{% load crispy_forms_tags %}
<html>
{% include "header.html" %}
<body>
{% include "navbar.html" %}
<section id="one" class="wrapper style3">
    <div class="inner">
        <header class="align-center">
            <h2>{{ course.title }}</h2>
        </header>
    </div>
</section>
<section id="two" class="wrapper style2">
    <div class="inner">
        <h3>
            <a href="/courses">
                <i class="fas fa-arrow-left"></i>&nbsp;All courses
            </a>
        </h3>
        <div class="box">
            {% block content %}
                <div class="content">
                {% if course.created_date %}
                    <div class="date">{{ course.created_date }}</div>
                {% endif %}
                <h2>{{ course.title }}</h2>
                <div class="table-wrapper">
                    <table>
                        <tbody>
                            <tr>
                                <td><b>Topic</b></td>
                                <td>{{ course.topic }}</td>
                            </tr>
                            <tr>
                                <td><b>Author</b></td>
                                <td>{{ course.owner.first_name }}</td>
                            </tr>
                            <tr>
                                <td><b>Price</b></td>
                                <td>{{ course.price }}</td>
                            </tr>
                            <tr>
                                <td><b>Description</b></td>
                                <td>{{ course.description }}</td>
                            </tr>
                    </table>
                </div>
                <p>
                    {% if user != course.owner  %}
                        {% if user_enrolled %}
                            <b>You are enrolled. <a href="/courses/unenroll/{{ course.pk }}">Unenroll</a>?</b>
                        {% else %}
                            <form method="POST" class="course-form" action="/courses/enroll/{{ course.pk }}/">
                                {% csrf_token %}
                                <button type="submit" class="button special fit">Enroll</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <a href='/courses/enrolled_list/{{ course.pk }}/'>Enrolled students</a>
                    {% endif %}
                </p>
                <ul>
                    {% if not user_enrolled %}
                        <h4><b>NOTE</b>: Before accessing course contents you should be enrolled in the course.</h4>
                        {% for entry in course_entries %}
                            <li>{{entry.name}}</li>
                        {% endfor %}
                    {% elif user == course.owner %}
                        {% for entry in course_entries %}
                            {% if entry.entry_type == 'lesson' %}
                                <li><a href="/courses/lesson/{{ entry.pk }}">{{entry.name}}</a></li>
                            {% endif %}
                            {% if entry.entry_type == 'video' %}
                                <li><a href="/courses/video/{{ entry.pk }}">{{entry.name}}</a></li>
                            {% endif %}
                            {% if entry.entry_type == 'quiz' %}
                                <li><a href="/courses/quiz/{{ entry.pk }}">{{entry.name}}</a></li>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div id="progress-wrapper">
                            <label for="progress-bar">Progress:</label>
                            <progress id="progress-bar" max="100" value="0"></progress>
                            <div id="progress-bar-message"></div>
                        </div>
                        <hr>
                        {% for entry in course_progression %}
                            {% if entry.course_entry.entry_type == 'lesson' %}
                                <li>
                                    <div>
                                        <div class="left">
                                            <a href="/courses/lesson/{{ entry.course_entry.pk }}">{{ entry.course_entry.name }}</a>
                                        </div>
                                        <div class="right">
                                            {% if entry.completed %}
                                                <span style="color: darkgreen; "><i class="fas fa-check-circle"></i>Completed</span>
                                            {% else %}
                                                <span style="color: red; ">In progress</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </li>
                            {% endif %}
                            {% if entry.course_entry.entry_type == 'video' %}
                                <li>
                                    <div>
                                        <div class="left">
                                            <a href="/courses/video/{{ entry.course_entry.pk }}">{{entry.course_entry.name}}</a>
                                        </div>
                                        <div class="right">
                                            {% if entry.completed %}
                                                <span style="color: darkgreen; "<i class="fas fa-check-circle"></i>Completed</span>
                                            {% else %}
                                                <span style="color: red; ">In progress</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </li>
                            {% endif %}
                            {% if entry.course_entry.entry_type == 'quiz' %}
                                <li>
                                    <div>
                                        <div class="left">
                                            <a href="/courses/quiz/{{ entry.course_entry.pk }}">{{ entry.course_entry.name }}</a>
                                        </div>
                                        <div class="right">
                                            {% if entry.completed %}
                                                <span style="color: darkgreen; "><i class="fas fa-check-circle"></i>Completed</span>
                                            {% else %}
                                                <span style="color: red; ">In progress</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </li>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </ul>
                <hr>
                {% if user == course.owner %}
                    <p><a href='/courses/add_entry/{{ course.pk }}' class="button special">Add course entry</a></p>
                {% endif %}
                </div>
            {% endblock %}
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){
        function updateProgress() {
            let url = "/courses/get_progress/{{ course.pk }}";
            fetch(url).then(function(response) {
              response.json().then(function(progress) {
                  if (progress.total !== 0) {
                      document.getElementById("progress-bar").value = progress.completed / progress.total * 100;
                      document.getElementById("progress-bar-message").innerHTML =
                          progress.completed + ' of ' + progress.total + ' course entries completed.';
                  } else {
                      document.getElementById("progress-bar").value = 0;
                      document.getElementById("progress-bar-message").innerHTML =
                          progress.completed + ' of ' + progress.total + ' course entries completed.';
                  }
              });
          });
        }
        updateProgress();
    });
</script>
</body>
</html>
