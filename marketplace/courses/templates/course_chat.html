{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}
<html>
{% include "header.html" %}
<body>
{% include "navbar.html" %}
<section id="one" class="wrapper style3">
    <div class="inner">
        <header class="align-center">
            <h2>{{ course.title }}</h2>
        </header>
    </div>
</section>
<section id="two" class="wrapper style2">
    <div class="inner">
        <h3>
            <a href="/course/{{ course.topic }}">
                <i class="fas fa-arrow-left"></i>&nbsp;
            </a>
        </h3>
        <div class="box">
            {% block content %}
                <div class="content">
                    <form id="input-form" class="form-inline">
                        <div class="form-group">
                          <input id="input-handle" type="hidden" class="form-control" value="{{ user.first_name }}"  />
                        </div>
                        <div class="form-group">
                          <input id="input-text" type="text" class="form-control" placeholder="Enter chat text here" autofocus />
                        </div>
                        <button class="btn btn-primary" type="submit">Send</button>
                    </form>
                    <div class="table">
                        <table>
                            <tbody id="chat-text">
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endblock %}
        </div>
    </div>
</section>
<script>
var box = new ReconnectingWebSocket("wss://edu-marketplace-chat.herokuapp.com/ws");
var chatId = '{{ course.pk }}';

box.onmessage = function(message) {
  var data = JSON.parse(message.data);
  console.log(data)
  if(chatId == data.chatId) {
      $("#chat-text").append("<tr><td><b>" + data.handle + "</b></td><td>" + data.text + "</td></tr>");
      $("#chat-text").stop().animate({
        scrollTop: $('#chat-text')[0].scrollHeight
      }, 800);
  }
};

box.onclose = function(){
    console.log('box closed');
    this.box = new WebSocket(box.url);
};

$("#input-form").on("submit", function(event) {
  event.preventDefault();
  var handle = $("#input-handle")[0].value;
  var text   = $("#input-text")[0].value;
  box.send(JSON.stringify({ handle: handle, text: text, chatId: chatId}));
  $("#input-text")[0].value = "";
});

</script>
</body>
</html>
